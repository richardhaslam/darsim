%Add Pc to right-hand side of the pressure equation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Matteo Cusini's Research Code
%Author: Matteo Cusini
%TU Delft
%Year: 2015
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function [q, Pc] = AddPcToPressureSystem(q, Fluid, Grid)
N = Grid.Nx*Grid.Ny;
Q = reshape(q, Grid.Nx, Grid.Ny);
[Tx, Ty] = ComputeTransmissibility(Grid, Kw);

%Compute Pc for the Saturation distribution given
[Pc, ~] = ComputePc(S, Fluid);

%Add Pc to the right-hand side
%"Capillary fluxes"
U.x = zeros(Nx+1,Ny,1);
U.y = zeros(Nx,Ny+1,1);
U.x(2:Nx,:) = (Pc(1:Nx-1,:)-Pc(2:Nx,:)).*Tx(2:Nx,:);
U.y(:,2:Ny)  = (Pc(:,1:Ny-1)-Pc(:,2:Ny)).*Ty(:,2:Ny);
%Right-hand side
Q (:,:) = U.x(1:Nx, :) - U.x() + U.y - U.y();
%reshape
q = reshape(Q, Grid.N, 1);
end